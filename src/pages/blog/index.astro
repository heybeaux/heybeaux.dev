---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

// Get all blog posts, filter drafts in production
const allPosts = await getCollection('blog', ({ data }) => {
  return import.meta.env.PROD ? !data.draft : true;
});

// Sort by date, newest first
const posts = allPosts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}
---

<Layout title="Blog — Beaux Walton" description="Writing about building things, breaking things, and occasionally fixing them.">
  <!-- Back to home -->
  <a href="/" class="text-sm font-mono text-[var(--color-muted)] hover:text-[var(--color-accent)] mb-8 inline-block">
    ← Back to home
  </a>
  
  <header class="mb-12">
    <h1 class="text-3xl font-mono font-semibold mb-4">Writing</h1>
    <p class="text-[var(--color-muted)] text-lg">
      Building things, breaking things, occasionally fixing them.
    </p>
  </header>

  {posts.length > 0 ? (
    <div class="grid gap-4">
      {posts.map((post) => (
        <a href={`/blog/${post.slug}`} class="card p-6 group block">
          <div class="flex flex-wrap items-baseline justify-between gap-2 mb-2">
            <h2 class="text-xl font-semibold group-hover:text-[var(--color-accent)] transition-colors">
              {post.data.title}
            </h2>
            <span class="text-sm text-[var(--color-muted)] font-mono">
              {formatDate(post.data.date)}
            </span>
          </div>
          <p class="text-[var(--color-muted)] mb-3">
            {post.data.excerpt}
          </p>
          {post.data.tags.length > 0 && (
            <div class="flex flex-wrap gap-2">
              {post.data.tags.map((tag) => (
                <span class="text-xs font-mono text-[var(--color-muted)] bg-[var(--color-bg)] px-2 py-1 rounded border border-[var(--color-border)]">
                  #{tag}
                </span>
              ))}
            </div>
          )}
          {post.data.draft && (
            <span class="tag mt-3 inline-block">Draft</span>
          )}
        </a>
      ))}
    </div>
  ) : (
    <div class="card p-8 text-center">
      <p class="text-[var(--color-muted)]">
        No posts yet. Check back soon.
      </p>
    </div>
  )}

  <!-- RSS link -->
  <div class="mt-12 pt-8 border-t border-[var(--color-border)]">
    <a href="/rss.xml" class="text-sm font-mono text-[var(--color-muted)] hover:text-[var(--color-accent)]">
      RSS Feed →
    </a>
  </div>
</Layout>
